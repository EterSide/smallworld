<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ìœ¨í‘œê³ ì •ì‹ Calculator</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <a href="/" class="back-link">â† ë’¤ë¡œê°€ê¸°</a>
            <h1 class="page-title">âš¡ ì—°ìœ¨í‘œê³ ì •ì‹ Calculator</h1>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Panel: Extra Deck & Settings -->
            <aside>
                <!-- Extra Deck Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">ì—‘ìŠ¤íŠ¸ë¼ ë±</span>
                        <span class="panel-badge" id="deck-count">0ì¥</span>
                    </div>

                    <!-- Search -->
                    <div class="search-wrapper">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="card-search" class="search-input" placeholder="ìœµí•©/ì—‘ì‹œì¦ˆ ëª¬ìŠ¤í„° ê²€ìƒ‰..."
                            autocomplete="off">
                        <div class="autocomplete-dropdown" id="search-dropdown"></div>
                    </div>

                    <!-- Monster Type Counts -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <div class="panel-badge" style="background: #9b59b6;">ğŸŸ£ ìœµí•©: <span id="fusion-count">0</span>
                        </div>
                        <div class="panel-badge" style="background: #2c3e50;">âš« ì—‘ì‹œì¦ˆ: <span id="xyz-count">0</span></div>
                    </div>

                    <!-- Extra Deck Cards -->
                    <div id="deck-list" class="card-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸƒ</div>
                            <p>ìœµí•©/ì—‘ì‹œì¦ˆ ëª¬ìŠ¤í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</p>
                        </div>
                    </div>

                    <div class="action-bar">
                        <button id="save-deck-btn" class="btn btn-secondary">ğŸ’¾ ì €ì¥</button>
                        <button id="clear-deck-btn" class="btn btn-secondary">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="panel" style="margin-top: 1rem;">
                    <div class="panel-header">
                        <span class="panel-title">ê³„ì‚° ì¡°ê±´</span>
                    </div>

                    <div class="number-input-group">
                        <label>ì–‘ìª½ íŒ¨/í•„ë“œ ì¹´ë“œ ìˆ˜ í•©ê³„</label>
                        <input type="number" id="total-card-count" class="number-input" min="1" max="30" value="10"
                            placeholder="ì¹´ë“œ ìˆ˜ ì…ë ¥">
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            ì œì™¸í•  3ì¥ì˜ ë³„ í•©ê³„ê°€ ì´ ìˆ˜ì™€ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤
                        </small>
                    </div>

                    <div class="number-input-group">
                        <label>ìƒëŒ€ ëª¬ìŠ¤í„° ë ˆë²¨/ë­í¬ (ë˜ëŒë¦¬ê¸°ìš©)</label>
                        <input type="number" id="target-level" class="number-input" min="0" max="13" value="0"
                            placeholder="0 = ì‚¬ìš© ì•ˆí•¨">
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            0ì´ë©´ ë˜ëŒë¦¬ê¸° ì¡°í•©ì„ ê³„ì‚°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                        </small>
                    </div>

                    <div id="star-range" style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        ê°€ëŠ¥í•œ ë³„ í•©ê³„: ê³„ì‚° ì¤‘...
                    </div>

                    <button id="calculate-btn" class="btn" style="width: 100%;">ğŸ” ì¡°í•© ê³„ì‚°í•˜ê¸°</button>
                </div>
            </aside>

            <!-- Right Panel: Results -->
            <main>
                <!-- Banish Results -->
                <div class="panel">
                    <div class="results-header">
                        <h2 class="results-title">1ë‹¨ê³„: ì œì™¸ ì¡°í•©</h2>
                        <span class="results-count" id="banish-count"></span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                        ê°™ì€ ë­í¬ì˜ ì—‘ì‹œì¦ˆ 2ì¥ + ìœµí•© 1ì¥ (ë³„ í•©ê³„ = ì¹´ë“œ ìˆ˜)
                    </p>

                    <div id="banish-results">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>ì¡°í•© ê³„ì‚°í•˜ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>

                <!-- Return Results -->
                <div class="panel" style="margin-top: 1rem;">
                    <div class="results-header">
                        <h2 class="results-title">2ë‹¨ê³„: ë˜ëŒë¦¬ê¸° ì¡°í•©</h2>
                        <span class="results-count" id="return-count"></span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                        ì—‘ì‹œì¦ˆ 1ì¥ + ìœµí•© 1ì¥ (ë³„ í•©ê³„ = ìƒëŒ€ ëª¬ìŠ¤í„° ë ˆë²¨)
                    </p>

                    <div id="return-results">
                        <div class="empty-state">
                            <div class="empty-state-icon">â†©ï¸</div>
                            <p>ìƒëŒ€ ëª¬ìŠ¤í„° ë ˆë²¨ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script th:inline="javascript">
        // State
        const state = {
            extraDeck: [],
            searchResults: [] // ê²€ìƒ‰ ê²°ê³¼ ìºì‹œ
        };

        // DOM Elements
        const cardSearch = document.getElementById('card-search');
        const searchDropdown = document.getElementById('search-dropdown');
        const deckList = document.getElementById('deck-list');
        const deckCount = document.getElementById('deck-count');
        const fusionCount = document.getElementById('fusion-count');
        const xyzCount = document.getElementById('xyz-count');
        const totalCardCountInput = document.getElementById('total-card-count');
        const targetLevelInput = document.getElementById('target-level');
        const starRange = document.getElementById('star-range');
        const calculateBtn = document.getElementById('calculate-btn');
        const banishResults = document.getElementById('banish-results');
        const returnResults = document.getElementById('return-results');
        const banishCount = document.getElementById('banish-count');
        const returnCount = document.getElementById('return-count');
        const saveDeckBtn = document.getElementById('save-deck-btn');
        const clearDeckBtn = document.getElementById('clear-deck-btn');

        // Debounce
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Search
        const searchCards = debounce(async (query) => {
            if (query.length < 2) {
                searchDropdown.classList.remove('active');
                return;
            }

            try {
                const response = await fetch(`/numeron/api/search?query=${encodeURIComponent(query)}`);
                const cards = await response.json();

                // ê²€ìƒ‰ ê²°ê³¼ë¥¼ stateì— ì €ì¥
                state.searchResults = cards;

                if (cards.length === 0) {
                    searchDropdown.innerHTML = '<div class="autocomplete-item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                } else {
                    searchDropdown.innerHTML = cards.slice(0, 10).map((card, index) => `
                    <div class="autocomplete-item" data-card-index="${index}">
                        <img src="${card.imageUrl || '/images/card-back.png'}" alt="${escapeHtml(card.name)}">
                        <div class="autocomplete-item-info">
                            <div class="autocomplete-item-name">${escapeHtml(card.name)}</div>
                            <div class="autocomplete-item-stats">
                                ${getCardTypeLabel(card)} / ${card.type === 'Xyz Monster' ? 'Rank' : 'Lv.'} ${card.level || '-'}
                            </div>
                        </div>
                    </div>
                `).join('');
                }
                searchDropdown.classList.add('active');
            } catch (error) {
                console.error('Search failed:', error);
            }
        }, 300);

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCardTypeLabel(card) {
            if (card.type === 'Xyz Monster' || card.type === 'XYZ Monster') return 'âš« ì—‘ì‹œì¦ˆ';
            if (card.type === 'Fusion Monster') return 'ğŸŸ£ ìœµí•©';
            return card.type;
        }

        // Add card
        function addCard(card) {
            if (state.extraDeck.some(c => c.id === card.id)) {
                showToast('ì´ë¯¸ ì¶”ê°€ëœ ì¹´ë“œì…ë‹ˆë‹¤', 'warning');
                return;
            }

            state.extraDeck.push(card);
            renderDeck();
            updateStarRange();
            saveDeckToStorage();
            showToast(`${card.name} ì¶”ê°€ë¨`, 'success');
        }

        // Remove card
        function removeCard(cardId) {
            state.extraDeck = state.extraDeck.filter(c => c.id !== cardId);
            renderDeck();
            updateStarRange();
            saveDeckToStorage();
        }

        // Render deck
        function renderDeck() {
            const fusion = state.extraDeck.filter(c => c.type === 'Fusion Monster');
            const xyz = state.extraDeck.filter(c => c.type === 'Xyz Monster' || c.type === 'XYZ Monster');

            fusionCount.textContent = fusion.length;
            xyzCount.textContent = xyz.length;
            deckCount.textContent = `${state.extraDeck.length}ì¥`;

            if (state.extraDeck.length === 0) {
                deckList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸƒ</div>
                    <p>ìœµí•©/ì—‘ì‹œì¦ˆ ëª¬ìŠ¤í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>
            `;
                return;
            }

            deckList.innerHTML = state.extraDeck.map(card => `
            <div class="card-item" data-card-id="${card.id}">
                <img src="${card.imageUrl || '/images/card-back.png'}" alt="${card.name}">
                <div class="card-item-info">
                    <div class="card-item-name">${card.name}</div>
                    <div class="card-item-stats">
                        ${getCardTypeLabel(card)} / â˜…${card.level || '-'}
                    </div>
                </div>
                <button class="card-item-remove" data-remove-id="${card.id}">âœ•</button>
            </div>
        `).join('');
        }

        // Update star range
        async function updateStarRange() {
            if (state.extraDeck.length === 0) {
                starRange.textContent = 'ê°€ëŠ¥í•œ ë³„ í•©ê³„: ì¹´ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”';
                return;
            }

            try {
                const response = await fetch('/numeron/api/range', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state.extraDeck.map(c => c.id))
                });
                const range = await response.json();

                if (range[0] === 0 && range[1] === 0) {
                    starRange.textContent = 'âš ï¸ ê°™ì€ ë­í¬ ì—‘ì‹œì¦ˆ 2ì¥ ì´ìƒ + ìœµí•© 1ì¥ ì´ìƒ í•„ìš”';
                    starRange.style.color = 'var(--warning)';
                } else {
                    starRange.textContent = `ê°€ëŠ¥í•œ ë³„ í•©ê³„: ${range[0]} ~ ${range[1]}`;
                    starRange.style.color = 'var(--success)';
                }
            } catch (error) {
                console.error('Failed to get range:', error);
            }
        }

        // Calculate
        async function calculate() {
            const totalCardCount = parseInt(totalCardCountInput.value) || 0;
            const targetLevel = parseInt(targetLevelInput.value) || 0;

            if (state.extraDeck.length < 3) {
                showToast('ìµœì†Œ 3ì¥ì˜ ì¹´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                return;
            }

            banishResults.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            returnResults.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            try {
                const response = await fetch('/numeron/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        extraDeckIds: state.extraDeck.map(c => c.id),
                        totalCardCount: totalCardCount,
                        targetLevel: targetLevel
                    })
                });

                const result = await response.json();
                renderBanishResults(result.banishCombinations);
                renderReturnResults(result.fullSequences, targetLevel);
            } catch (error) {
                console.error('Calculate failed:', error);
                showToast('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // Render banish results
        function renderBanishResults(combinations) {
            banishCount.textContent = `${combinations.length}ê°œ ë°œê²¬`;

            if (combinations.length === 0) {
                banishResults.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ˜”</div>
                    <p>ê°€ëŠ¥í•œ ì œì™¸ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">
                        ì¹´ë“œ ìˆ˜ ë˜ëŠ” ì—‘ìŠ¤íŠ¸ë¼ ë±ì„ ì¡°ì •í•´ë³´ì„¸ìš”
                    </p>
                </div>
            `;
                return;
            }

            banishResults.innerHTML = `
            <div class="path-grid">
                ${combinations.map(combo => `
                    <div class="path-card">
                        <div class="path-flow">
                            <div class="path-card-item">
                                <img src="${combo.xyz1.imageUrl || '/images/card-back.png'}" alt="${combo.xyz1.name}">
                                <span class="name">â˜…${combo.xyz1.level}</span>
                            </div>
                            <span class="path-arrow">+</span>
                            <div class="path-card-item">
                                <img src="${combo.xyz2.imageUrl || '/images/card-back.png'}" alt="${combo.xyz2.name}">
                                <span class="name">â˜…${combo.xyz2.level}</span>
                            </div>
                            <span class="path-arrow">+</span>
                            <div class="path-card-item">
                                <img src="${combo.fusion.imageUrl || '/images/card-back.png'}" alt="${combo.fusion.name}">
                                <span class="name">â˜…${combo.fusion.level}</span>
                            </div>
                        </div>
                        <div class="path-match-info">
                            <div>ì—‘ì‹œì¦ˆ ë­í¬: <span>${combo.xyz1.level}</span> (ë™ì¼)</div>
                            <div>ë³„ í•©ê³„: <span>${combo.xyz1.level + combo.xyz2.level + combo.fusion.level}</span></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        }

        // Render return results
        function renderReturnResults(fullSequences, targetLevel) {
            if (targetLevel === 0) {
                returnResults.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">â†©ï¸</div>
                    <p>ìƒëŒ€ ëª¬ìŠ¤í„° ë ˆë²¨ì„ ì…ë ¥í•˜ë©´<br>ë˜ëŒë¦¬ê¸° ì¡°í•©ì„ ê³„ì‚°í•©ë‹ˆë‹¤</p>
                </div>
            `;
                returnCount.textContent = '';
                return;
            }

            const entries = Object.entries(fullSequences || {});
            let totalCount = 0;
            entries.forEach(([_, combos]) => totalCount += combos.length);

            returnCount.textContent = `${totalCount}ê°œ ë°œê²¬`;

            if (totalCount === 0) {
                returnResults.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ˜”</div>
                    <p>ë ˆë²¨ ${targetLevel}ì— ë§ëŠ” ë˜ëŒë¦¬ê¸° ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            `;
                return;
            }

            let html = '<div class="path-grid">';

            entries.forEach(([banishKey, returnCombos]) => {
                returnCombos.forEach(combo => {
                    html += `
                    <div class="path-card">
                        <div class="path-flow">
                            <div class="path-card-item">
                                <img src="${combo.xyz.imageUrl || '/images/card-back.png'}" alt="${combo.xyz.name}">
                                <span class="name">â˜…${combo.xyz.level}</span>
                            </div>
                            <span class="path-arrow">+</span>
                            <div class="path-card-item">
                                <img src="${combo.fusion.imageUrl || '/images/card-back.png'}" alt="${combo.fusion.name}">
                                <span class="name">â˜…${combo.fusion.level}</span>
                            </div>
                        </div>
                        <div class="path-match-info">
                            <div>ë³„ í•©ê³„: <span>${combo.xyz.level + combo.fusion.level}</span> = ìƒëŒ€ ë ˆë²¨</div>
                        </div>
                    </div>
                `;
                });
            });

            html += '</div>';
            returnResults.innerHTML = html;
        }

        // Storage
        function saveDeckToStorage() {
            localStorage.setItem('numeron-deck', JSON.stringify(state.extraDeck.map(c => c.id)));
        }

        async function loadDeckFromStorage() {
            const savedIds = JSON.parse(localStorage.getItem('numeron-deck') || '[]');
            if (savedIds.length === 0) return;

            try {
                const response = await fetch('/numeron/api/cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(savedIds)
                });
                state.extraDeck = await response.json();
                renderDeck();
                updateStarRange();
            } catch (error) {
                console.error('Failed to load deck:', error);
            }
        }

        // Event listeners
        cardSearch.addEventListener('input', (e) => searchCards(e.target.value));

        searchDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.autocomplete-item');
            if (item && item.dataset.cardIndex !== undefined) {
                const index = parseInt(item.dataset.cardIndex);
                const card = state.searchResults[index];
                if (card) {
                    addCard(card);
                    cardSearch.value = '';
                    searchDropdown.classList.remove('active');
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (!searchDropdown.contains(e.target) && e.target !== cardSearch) {
                searchDropdown.classList.remove('active');
            }
        });

        deckList.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.card-item-remove');
            if (removeBtn) {
                e.stopPropagation();
                removeCard(parseInt(removeBtn.dataset.removeId));
            }
        });

        calculateBtn.addEventListener('click', calculate);

        saveDeckBtn.addEventListener('click', () => {
            saveDeckToStorage();
            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        });

        clearDeckBtn.addEventListener('click', () => {
            if (confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                state.extraDeck = [];
                renderDeck();
                updateStarRange();
                localStorage.removeItem('numeron-deck');
                showToast('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        });

        // Initialize
        loadDeckFromStorage();
    </script>
</body>

</html>